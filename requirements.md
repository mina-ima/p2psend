📄 アプリ要件定義書（ドラフト）

アプリ名（仮）

P2P Send（仮）
アカウント不要・端末間直接通信によるシンプルなファイル送受信アプリ

⸻

🎯 目的
•サーバーやクラウドを経由せず、端末同士でファイルを直接送受信できる
•アカウント登録不要
•QRコードやリンクで簡単接続
•すべての主要プラットフォームで動作

⸻

🖥️ 対応プラットフォーム
•iOS（アプリ）
•Android（アプリ）
•Windows（アプリ）
•Mac（アプリ）
•Webブラウザ（インストール不要）

⸻

🔌 接続方式
•Bluetooth通信（近距離）
•同一Wi-Fiネットワーク内通信（LAN）
•WebRTCなどによるローカルP2P通信

⸻

🔐 接続方法
•接続はすべて一時的。履歴やお気に入り機能はなし
•起動時に QRコード表示 + カメラ読み取り画面 を同時に表示
•遠距離対応用に 一時的な接続コード or URL も選択可能

⸻

📁 ファイル送受信機能
•形式：画像・PDF・動画・ZIPなど、一般的なファイルにすべて対応
•容量：1ファイルあたり数GBまで対応（端末のスペックと帯域に依存）
•複数ファイル：一括送信可（D&D または複数選択）
•ファイルは接続相手の「ダウンロードフォルダ」へ即時保存
•UIは送信用の D&Dエリア＋ファイル選択ボタンのみの超シンプル構成
•ファイル送信時／受信時には相手に通知（バナーまたは音）

⸻

🔒 セキュリティとプライバシー
•アカウント不要・ログインなし
•通信は端末間で暗号化（例：WebRTCのDTLS/SRTP）
•ファイルもアプリ外に保存されず、自動的にダウンロードフォルダへ
•利用ログやアクセス記録は一切保存しない
•完全無料・広告なし

⸻

⚙️ サーバー構成
•シグナリングサーバーとしてPeerJS Serverを使用
•ポート: 9000
•パス: /peerjs
•独立したNode.jsプロセスとして運用

## エラー解析情報

### 1. 接続失敗 (Negotiation of connection failed)

**問題:**
PeerJSを使用したP2P接続において、`Negotiation of connection failed` および `iceConnectionState is failed` エラーが発生し、接続が確立できない。このエラーは、当初はファイル送信ボタンを押す前に発生していたが、後にファイル選択前にも発生することが判明。

**初期分析と対応:**
*   `src/App.tsx` にてPeerJSが初期化されており、STUN/TURNサーバーのリストが設定されていることを確認。
*   既存のSTUN/TURNサーバーリストに、信頼性の低い無料のTURNサーバーや不安定なSTUNサーバーが含まれていることが判明。
*   **対応:** より信頼性の高いGoogleのSTUNサーバーを中心にリストを更新し、不安定なサーバーを削除。

**追加分析と対応 (ファイル選択前エラー発生を受けて):**
*   STUN/TURNサーバーリストの更新後もエラーが継続し、ファイル選択前にも発生することが判明。これは、接続確立自体に問題があることを示唆。
*   `iceConnectionState is failed` はWebRTCの接続確立プロセス（ICE候補の交換、NATトラバーサル）の失敗を意味する。
*   **対応:**
    *   接続が切断されたりエラーが発生したりした場合に、`connection` ステートが適切に `null` にリセットされるように `src/App.tsx` の `conn.on('error')` および `conn.on('close')` イベントハンドラを修正。これにより、UIが「未接続」の状態に戻り、切断された接続に対して操作しようとすることを防ぐ。
    *   PeerJSのデバッグレベルを `3` から `4` に引き上げ、より詳細なログを取得できるように設定変更。これにより、接続失敗の具体的な原因を特定するための情報収集を強化。

**現在の状況:**
*   STUN/TURNサーバーリストの改善と、接続状態のリセットロジックの追加は完了。
*   PeerJSのデバッグレベルを最大に設定済み。
*   ユーザーには、アプリケーションを再ビルドし、詳細なログを提供して再テストを依頼中。